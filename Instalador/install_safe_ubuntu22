#!/bin/bash

# Instalador SEGURO - Protege sistema existente
# Baseado no instalador original mas com verificaÃ§Ãµes de seguranÃ§a

echo "ğŸ”’ WhatiTicket Plus - Instalador SEGURO (NÃ£o quebra sistema existente)"
echo "============================================================================="

# ImportaÃ§Ãµes originais
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  PROJECT_ROOT="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$PROJECT_ROOT/$SOURCE"
done
PROJECT_ROOT="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

source "${PROJECT_ROOT}"/variables/manifest.sh
source "${PROJECT_ROOT}"/utils/manifest.sh

# Load system functions
if [[ -f "${PROJECT_ROOT}"/lib/_system_ubuntu22.sh ]]; then
  source "${PROJECT_ROOT}"/lib/_system_ubuntu22.sh
else
  source "${PROJECT_ROOT}"/lib/_system.sh
fi

source "${PROJECT_ROOT}"/lib/_backend.sh
source "${PROJECT_ROOT}"/lib/_frontend.sh
source "${PROJECT_ROOT}"/lib/_inquiry.sh

# ğŸ” FUNÃ‡Ã•ES DE SEGURANÃ‡A
check_existing_installation() {
    echo "ğŸ” Verificando instalaÃ§Ã£o existente..."

    # Verificar se jÃ¡ existe database
    if sudo -u postgres psql -lqt | grep -qw "${instancia_add}"; then
        echo "âš ï¸ Database '${instancia_add}' jÃ¡ existe!"

        # Verificar se tem dados
        table_count=$(sudo -u postgres psql -d "${instancia_add}" -tAc "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';")
        if [[ $table_count -gt 0 ]]; then
            echo "âš ï¸ Database contÃ©m ${table_count} tabelas com dados!"

            read -p "â“ Deseja continuar mesmo assim? Isto pode causar perda de dados! (s/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Ss]$ ]]; then
                echo "âŒ InstalaÃ§Ã£o cancelada para proteger dados existentes."
                exit 1
            fi
        fi
    fi

    # Verificar se o diretÃ³rio jÃ¡ existe
    if [[ -d "/home/deploy/${instancia_add}" ]]; then
        echo "âš ï¸ DiretÃ³rio da instÃ¢ncia jÃ¡ existe: /home/deploy/${instancia_add}"

        # Verificar se tem processo PM2 rodando
        if pm2 list | grep -q "${instancia_add}"; then
            echo "âš ï¸ InstÃ¢ncia jÃ¡ estÃ¡ rodando no PM2!"

            read -p "â“ Deseja parar a instÃ¢ncia existente? (s/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Ss]$ ]]; then
                echo "â¹ï¸ Parando instÃ¢ncia existente..."
                pm2 stop "${instancia_add}" || echo "âš ï¸ NÃ£o foi possÃ­vel parar (pode jÃ¡ estar parada)"
            else
                echo "âŒ InstalaÃ§Ã£o cancelada para evitar conflitos."
                exit 1
            fi
        fi

        # Backup dos dados existentes
        backup_dir="/home/deploy/${instancia_add}_backup_$(date +%Y%m%d_%H%M%S)"
        echo "ğŸ’¾ Criando backup em: ${backup_dir}"
        cp -r "/home/deploy/${instancia_add}" "${backup_dir}"
        echo "âœ… Backup criado com sucesso!"
    fi

    # Verificar portas em uso
    if netstat -tuln | grep -q ":${backend_port}"; then
        echo "âš ï¸ Porta ${backend_port} jÃ¡ estÃ¡ em uso!"
        echo "Verificando se Ã© nossa aplicaÃ§Ã£o..."

        if curl -s "http://localhost:${backend_port}/health" | grep -q "healthy"; then
            echo "âœ… Application jÃ¡ estÃ¡ rodando e saudÃ¡vel!"

            read -p "â“ Deseja atualizar a instalaÃ§Ã£o existente? (s/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Ss]$ ]]; then
                echo "âŒ InstalaÃ§Ã£o cancelada para evitar conflitos."
                exit 1
            fi

            UPDATE_MODE=true
        else
            echo "âŒ Outra aplicaÃ§Ã£o estÃ¡ usando a porta!"
            echo "Por favor, pare a outra aplicaÃ§Ã£o ou mude a porta."
            exit 1
        fi
    fi

    # Verificar Node.js versÃ£o
    if command -v node >/dev/null 2>&1; then
        node_version=$(node -v)
        echo "âœ… Node.js encontrado: ${node_version}"

        # Verificar compatibilidade
        node_major=$(echo "${node_version:1}" | cut -d'v' -f2)
        if [[ $node_major -lt 16 ]]; then
            echo "âš ï¸ Node.js ${node_major} detectado - pode haver incompatibilidades"
            echo "Recomendado: Node.js 16+"
        fi
    else
        echo "â„¹ï¸ Node.js nÃ£o encontrado - serÃ¡ instalado"
    fi
}

# ğŸ›¡ï¸ MIGRAÃ‡ÃƒO SEGURA
safe_migrate() {
    echo "ğŸ”„ Executando migraÃ§Ã£o segura..."

    # 1. Backup da database
    if sudo -u postgres psql -lqt | grep -qw "${instancia_add}"; then
        echo "ğŸ’¾ Fazendo backup da database..."
        backup_file="${instancia_add}_backup_$(date +%Y%m%d_%H%M%S).sql"
        sudo -u postgres pg_dump "${instancia_add}" > "/tmp/${backup_file}"
        echo "âœ… Backup salvo em /tmp/${backup_file}"

        # Comprimir backup
        gzip "/tmp/${backup_file}"
        echo "âœ… Backup comprimido"
    fi

    # 2. Verificar migrations existentes
    if [[ -d "${PROJECT_ROOT}/backend/src/database/migrations" ]]; then
        migration_count=$(ls "${PROJECT_ROOT}/backend/src/database/migrations"/*.js 2>/dev/null | wc -l)
        echo "ğŸ“‹ Encontradas ${migration_count} migraÃ§Ãµes para executar"

        # Verificar se jÃ¡ rodamos estas migraÃ§Ãµes
        if sudo -u postgres psql -d "${instancia_add}" -tAc "SELECT COUNT(*) FROM SequelizeMeta" 2>/dev/null | grep -q "0"; then
            echo "âœ… Database nova - executando todas as migraÃ§Ãµes"
            return
        fi

        # Contar migraÃ§Ãµes jÃ¡ rodadas
        run_migrations=$(sudo -u postgres psql -d "${instancia_add}" -tAc "SELECT COUNT(*) FROM SequelizeMeta" 2>/dev/null | grep -o '[0-9]\+' || echo "0")

        if [[ $run_migrations -gt 0 ]]; then
            echo "âš ï¸ JÃ¡ existem ${run_migrations} migraÃ§Ãµes rodadas"
            echo "Verificando se sÃ£o as mesmas..."

            # Verificar Ãºltima migraÃ§Ã£o
            last_migration=$(sudo -u postgres psql -d "${instancia_add}" -tAc "SELECT name FROM SequelizeMeta ORDER BY createdAt DESC LIMIT 1" 2>/dev/null)
            if [[ ! -z "$last_migration" ]]; then
                echo "Ãšltima migraÃ§Ã£o rodada: ${last_migration}"

                # Verificar se a Ãºltima migraÃ§Ã£o Ã© uma das nossas
                if [[ "$last_migration" == *"create-whatsapp-providers"* ]] ||
                   [[ "$last_migration" == *"create-flows"* ]] ||
                   [[ "$last_migration" == *"create-feature-flags"* ]]; then
                    echo "âœ… Novas migraÃ§Ãµes jÃ¡ foram rodadas - pulando etapa"
                    return
                fi
            fi
        fi
    fi
}

# ğŸ“¦ BACKUP AUTOMÃTICO
create_full_backup() {
    echo "ğŸ”„ Criando backup completo do sistema..."

    backup_name="whaticket_backup_$(date +%Y%m%d_%H%M%S)"
    backup_dir="/tmp/${backup_name}"

    mkdir -p "${backup_dir}"

    # 1. Backup da database
    if sudo -u postgres psql -lqt | grep -qw "${instancia_add}"; then
        echo "ğŸ’¾ Fazendo backup da database..."
        sudo -u postgres pg_dump "${instancia_add}" > "${backup_dir}/database.sql"
        gzip "${backup_dir}/database.sql"
    fi

    # 2. Backup dos arquivos da instÃ¢ncia
    if [[ -d "/home/deploy/${instancia_add}" ]]; then
        echo "ğŸ’¾ Fazendo backup dos arquivos da instÃ¢ncia..."
        cp -r "/home/deploy/${instancia_add}" "${backup_dir}/instance"
    fi

    # 3. Backup de configuraÃ§Ãµes
    if [[ -f "/home/deploy/${instancia_add}/backend/.env" ]]; then
        cp "/home/deploy/${instancia_add}/backend/.env" "${backup_dir}/.env"
    fi

    # 4. Backup do PM2
    pm2 save

    echo "âœ… Backup completo criado em: ${backup_dir}"
    echo "Para restaurar: sudo rsync -a ${backup_dir}/instance/ /home/deploy/${instancia_add}/"
}

# ğŸš¨ VALIDAÃ‡ÃƒO PÃ“S-INSTALAÃ‡ÃƒO
validate_installation() {
    echo "ğŸ” Validando instalaÃ§Ã£o..."

    local errors=0

    # 1. Verificar se services estÃ£o rodando
    if ! pm2 list | grep -q "${instancia_add}.*online"; then
        echo "âŒ Backend nÃ£o estÃ¡ rodando no PM2"
        ((errors++))
    else
        echo "âœ… Backend estÃ¡ rodando no PM2"
    fi

    # 2. Verificar se porta estÃ¡ respondendo
    sleep 5
    if ! curl -s "http://localhost:${backend_port}/health" | grep -q "healthy"; then
        echo "âŒ Backend nÃ£o estÃ¡ respondendo na porta ${backend_port}"
        ((errors++))
    else
        echo "âœ… Backend estÃ¡ respondendo corretamente"
    fi

    # 3. Verificar database
    if ! sudo -u postgres psql -d "${instancia_add}" -c "SELECT 1" >/dev/null 2>&1; then
        echo "âŒ Database nÃ£o estÃ¡ acessÃ­vel"
        ((errors++))
    else
        echo "âœ… Database estÃ¡ acessÃ­vel"
    fi

    # 4. Verificar Redis
    if ! docker exec "redis-${instancia_add}" redis-cli ping >/dev/null 2>&1; then
        echo "âŒ Redis nÃ£o estÃ¡ respondendo"
        ((errors++))
    else
        echo "âœ… Redis estÃ¡ respondendo"
    fi

    # 5. Verificar logs de erros
    backend_errors=$(pm2 logs "${instancia_add}" --lines 50 --err 2>/dev/null | grep -c "ERROR\|FATAL" || echo "0")
    if [[ $backend_errors -gt 0 ]]; then
        echo "âš ï¸ Encontrados ${backend_errors} erros no backend - verifique os logs"
    fi

    if [[ $errors -gt 0 ]]; then
        echo ""
        echo "âŒ InstalaÃ§Ã£o concluÃ­da com ${errors} erros!"
        echo "Verifique os logs para mais detalhes:"
        echo "  pm2 logs ${instancia_add}"
        echo "  sudo journalctl -u nginx"
        return 1
    else
        echo ""
        echo "âœ… InstalaÃ§Ã£o validada com sucesso!"
        return 0
    fi
}

# ğŸ”„ ROLLBACK EM CASO DE PROBLEMAS
rollback_installation() {
    echo "ğŸ”„ Executando rollback da instalaÃ§Ã£o..."

    # Parar serviÃ§os
    pm2 stop "${instancia_add}" 2>/dev/null || true
    sudo systemctl stop nginx 2>/dev/null || true

    # Restaurar backup se existir
    latest_backup=$(ls -t /tmp/whaticket_backup_* 2>/dev/null | head -1)
    if [[ ! -z "$latest_backup" ]]; then
        echo "ğŸ’¾ Restaurando do backup: ${latest_backup}"

        # Restaurar database
        if [[ -f "${latest_backup}/database.sql.gz" ]]; then
            gunzip -c "${latest_backup}/database.sql.gz" | sudo -u postgres psql "${instancia_add}"
        fi

        # Restaurar arquivos
        if [[ -d "${latest_backup}/instance" ]]; then
            sudo rm -rf "/home/deploy/${instancia_add}" 2>/dev/null || true
            sudo cp -r "${latest_backup}/instance" "/home/deploy/"
            sudo chown -R deploy:deploy "/home/deploy/${instancia_add}"
        fi

        echo "âœ… Rollback concluÃ­do!"
    else
        echo "âš ï¸ Nenhum backup encontrado para restaurar"
    fi

    # Reiniciar serviÃ§os do estado anterior
    sudo systemctl start nginx 2>/dev/null || true
    pm2 resurrect 2>/dev/null || true
}

# â”€â”€â”€ EXECUÃ‡ÃƒO PRINCIPAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# 1. VerificaÃ§Ã£o de seguranÃ§a
check_existing_installation

# 2. Pergunta se quer backup
read -p "ğŸ’¾ Deseja criar backup completo antes de prosseguir? (S/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Ss]$ ]]; then
    create_full_backup
fi

# 3. Sistema base (dependÃªncias)
system_update
system_node_install
system_pm2_install
system_docker_install
system_puppeteer_dependencies
system_snapd_install
system_nginx_install
system_certbot_install

# 4. Sistema config
system_create_user

# 5. Backend com seguranÃ§a
system_git_clone
backend_set_env
backend_redis_create
backend_node_dependencies

# 6. MigraÃ§Ã£o segura
safe_migrate

# 7. Build e start
backend_node_build

# 8. Database com validaÃ§Ã£o
echo "ğŸ—„ï¸ Configurando database..."
if ! sudo -u postgres psql -lqt | grep -qw "${instancia_add}"; then
    # Criar database nova
    sudo su - postgres <<EOF
    createdb ${instancia_add};
    psql
    CREATE USER ${instancia_add} SUPERUSER INHERIT CREATEDB CREATEROLE;
    ALTER USER ${instancia_add} PASSWORD '${mysql_root_password}';
    \q
    exit
EOF
fi

# Executar migrations com validaÃ§Ã£o
echo "ğŸ”„ Executando migrations..."
if ! npm run db:migrate; then
    echo "âŒ Erro nas migraÃ§Ãµes!"
    echo "Deseja fazer rollback para o estado anterior? (S/N): " -n 1 -r
    read -r
    echo
    if [[ $REPLY =~ ^[Ss]$ ]]; then
        rollback_installation
        exit 1
    fi
fi

# Seed com validaÃ§Ã£o
if ! npm run db:seed; then
    echo "âš ï¸ Erro no seed - pode ser normal se jÃ¡ existe dados"
fi

backend_start_pm2

# 9. Frontend
frontend_set_env
frontend_node_dependencies
frontend_node_build
frontend_start_pm2

# 10. Network
system_nginx_conf
system_nginx_restart
system_certbot_setup

# 11. ValidaÃ§Ã£o final
if validate_installation; then
    echo ""
    print_banner
    printf "${WHITE} âœ… INSTALAÃ‡ÃƒO CONCLUÃDA COM SUCESSO!${GRAY_LIGHT}"
    printf "\n\n"
    printf "${WHITE} ğŸŒ Acesse: https://${backend_url}${GRAY_LIGHT}"
    printf "\n"
    printf "${WHITE} ğŸ‘¤ UsuÃ¡rio: ${deploy_password}${GRAY_LIGHT}"
    printf "\n"
    printf "${WHITE} ğŸ”§ Scripts: /home/deploy/${instancia_add}/scripts/${GRAY_LIGHT}"
    printf "\n\n"
else
    echo ""
    echo "âŒ Ocorreram erros na instalaÃ§Ã£o!"
    echo ""
    read -p "Deseja fazer rollback automÃ¡tico? (S/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Ss]$ ]]; then
        rollback_installation
    fi

    exit 1
fi