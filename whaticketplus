#!/bin/bash

# My-Tycket v28 - Instalador Autom√°tico Completo
# Compat√≠vel com Ubuntu 20.04, 22.04 e 24.04 LTS
# Autor: DEV7Kadu
# Vers√£o: 2.0 - Script Auto-contido

set -e  # Parar em caso de erro

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Fun√ß√£o para imprimir banner
print_banner() {
    echo -e "${BLUE}"
    echo "                                                     ‚ñÑ‚ñÑ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñà‚ñÑ‚ñÑ"
    echo "                                                   ‚ñÑ‚ñà‚ñÄ   ‚ñÑ‚ñÑ      ‚ñÄ‚ñà‚ñÑ"
    echo "                                                   ‚ñà    ‚ñà‚ñà‚ñà         ‚ñà"
    echo "                                                   ‚ñà    ‚ñà‚ñà‚ñÑ         ‚ñà"
    echo "                                                   ‚ñà     ‚ñÄ‚ñà‚ñà‚ñÑ ‚ñà‚ñà    ‚ñà"
    echo "                                                   ‚ñà       ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ    ‚ñà"
    echo "                                                   ‚ñÄ‚ñà‚ñÑ           ‚ñÑ‚ñà‚ñÄ"
    echo "                                                    ‚ñÑ‚ñà    ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñà‚ñÄ‚ñÄ"
    echo "                                                    ‚ñà  ‚ñÑ‚ñà‚ñÄ"
    echo "                                                    ‚ñÄ‚ñÄ‚ñÄ‚ñÄ"
    echo ""
    echo "‚ñà‚ñà     ‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
    echo "‚ñà‚ñà     ‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà      ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà         ‚ñà‚ñà"
    echo "‚ñà‚ñà  ‚ñà  ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà      ‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà      ‚ñà‚ñà"
    echo "‚ñà‚ñà ‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà      ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà         ‚ñà‚ñà"
    echo " ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà  ‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà"
    echo ""
    echo -e "${CYAN}                    üíª My-Tycket v28.0.0 - Instalador Autom√°tico${NC}"
    echo -e "${CYAN}                     üöÄ WhatsApp Dual Provider + FlowBuilder${NC}"
    echo -e "${NC}"
}

# Fun√ß√£o para verificar se √© root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}‚ùå Este script precisa ser executado como root (sudo)${NC}"
        echo -e "${YELLOW}üí° Execute: sudo $0${NC}"
        exit 1
    fi
}

# Fun√ß√£o para detectar sistema
detect_system() {
    echo -e "${PURPLE} üîç Detectando sistema...${NC}"

    if command -v lsb_release >/dev/null 2>&1; then
        UBUNTU_VERSION=$(lsb_release -rs 2>/dev/null || echo "unknown")
        UBUNTU_CODENAME=$(lsb_release -cs 2>/dev/null || echo "unknown")
    else
        UBUNTU_VERSION="unknown"
        UBUNTU_CODENAME="unknown"
    fi

    echo -e "   üíª Sistema: ${GREEN}Ubuntu $UBUNTU_VERSION ($UBUNTU_CODENAME)${NC}"

    case $UBUNTU_VERSION in
        "20.04"|"22.04"|"24.04")
            echo -e "   ‚úÖ Vers√£o: ${GREEN}Totalmente compat√≠vel${NC}"
            ;;
        *)
            echo -e "   ‚ö†Ô∏è  Vers√£o: ${YELLOW}N√£o testada oficialmente${NC}"
            echo -e "   üìã Vers√µes recomendadas: 20.04, 22.04, 24.04"
            echo ""
            read -p "   ü§î Continuar mesmo assim? (s/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[SsYy]$ ]]; then
                echo -e "${RED}‚ùå Instala√ß√£o cancelada${NC}"
                exit 1
            fi
            ;;
    esac
}

# Fun√ß√£o para instalar depend√™ncias b√°sicas
install_dependencies() {
    echo -e "${PURPLE} üì¶ Instalando depend√™ncias b√°sicas...${NC}"

    apt update
    apt install -y curl wget git software-properties-common apt-transport-https ca-certificates gnupg lsb-release

    echo -e "   ‚úÖ Depend√™ncias b√°sicas instaladas"
}

# Fun√ß√£o para instalar Node.js
install_nodejs() {
    echo -e "${PURPLE} üíª Instalando nodejs (Ubuntu 22/24 compatible)...${NC}"

    # Remover TODAS as instala√ß√µes antigas para evitar conflitos
    echo -e "   üóëÔ∏è Removendo instala√ß√µes antigas..."
    apt remove -y --purge nodejs npm libnode-dev libnode72 || true
    apt autoremove -y || true
    apt autoclean || true

    # For√ßar limpeza de arquivos residuais
    rm -rf /usr/include/node /usr/local/lib/node_modules /usr/bin/node /usr/bin/npm 2>/dev/null || true

    # Adicionar reposit√≥rio NodeSource oficial
    echo -e "   üì¶ Adicionando reposit√≥rio NodeSource..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -

    # Atualizar lista de pacotes
    apt update

    # Instalar Node.js 20.x com tratamento de erro
    echo -e "   ‚¨áÔ∏è Instalando Node.js 20.x..."
    if ! apt-get install -y nodejs; then
        echo -e "   ‚ö†Ô∏è  Falha na instala√ß√£o via APT, tentando m√©todo alternativo..."

        # M√©todo alternativo: download direto
        NODE_VERSION="20.19.5"
        ARCH="x64"
        DEB_PACKAGE="node_${NODE_VERSION}-${ARCH}.deb"

        cd /tmp
        wget "https://deb.nodesource.com/node_${NODE_VERSION}/pool/main/n/nodejs/${DEB_PACKAGE}" || {
            echo -e "   ‚ùå Erro no download do Node.js"
            echo -e "   üìã Por favor, instale manualmente:"
            echo -e "      curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -"
            echo -e "      sudo apt-get install -y nodejs"
            exit 1
        }

        dpkg -i "$DEB_PACKAGE" || apt install -f -y
        rm -f "$DEB_PACKAGE"
    fi

    # Verificar instala√ß√£o
    if command -v node >/dev/null 2>&1; then
        NODE_VERSION=$(node --version)
        NPM_VERSION=$(npm --version)
        echo -e "   ‚úÖ Node.js: ${GREEN}$NODE_VERSION${NC}"
        echo -e "   ‚úÖ NPM: ${GREEN}$NPM_VERSION${NC}"
    else
        echo -e "   ‚ùå Node.js n√£o foi instalado corretamente"
        exit 1
    fi
}

# Fun√ß√£o para instalar PM2
install_pm2() {
    echo -e "${PURPLE} üíª Instalando pm2...${NC}"
    npm install -g pm2
    echo -e "   ‚úÖ PM2 instalado com sucesso"
}

# Fun√ß√£o para instalar Docker
install_docker() {
    echo -e "${PURPLE} üíª Instalando docker (Ubuntu 22/24 compatible)...${NC}"

    # Remover instala√ß√µes antigas
    echo -e "   üóëÔ∏è Removendo instala√ß√µes antigas do Docker..."
    apt remove -y docker docker-engine docker.io containerd runc docker-compose-plugin || true
    apt autoremove -y || true

    # Adicionar reposit√≥rio Docker oficial
    echo -e "   üì¶ Adicionando reposit√≥rio Docker..."
    if ! curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg; then
        echo -e "   ‚ö†Ô∏è  Falha ao adicionar chave GPG do Docker"
        return 1
    fi

    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

    apt update

    # Instalar Docker com retry
    echo -e "   ‚¨áÔ∏è Instalando Docker..."
    local DOCKER_RETRY=0
    while [ $DOCKER_RETRY -lt 3 ]; do
        if apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin; then
            echo -e "   ‚úÖ Docker instalado com sucesso"
            break
        else
            DOCKER_RETRY=$((DOCKER_RETRY + 1))
            echo -e "   ‚ö†Ô∏è  Tentativa $DOCKER_RETRY falhou, aguardando..."
            sleep 5
            apt update
        fi
    done

    if [ $DOCKER_RETRY -eq 3 ]; then
        echo -e "   ‚ùå Falha na instala√ß√£o do Docker ap√≥s 3 tentativas"
        echo -e "   üìã Continue manualmente: apt install docker-ce docker-ce-cli containerd.io docker-compose-plugin"
        return 1
    fi

    # Habilitar Docker
    systemctl enable docker || echo "   ‚ö†Ô∏è  Falha ao habilitar Docker na inicializa√ß√£o"
    systemctl start docker || echo "   ‚ö†Ô∏è  Falha ao iniciar Docker (pode j√° estar rodando)"

    echo -e "   ‚úÖ Docker instalado e iniciado"
}

# Fun√ß√£o para instalar PostgreSQL
install_postgresql() {
    echo -e "${PURPLE} üíª Instalando PostgreSQL...${NC}"

    # Adicionar reposit√≥rio PostgreSQL
    wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
    echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list

    apt update
    apt install -y postgresql postgresql-contrib

    # Habilitar PostgreSQL
    systemctl enable postgresql
    systemctl start postgresql

    echo -e "   ‚úÖ PostgreSQL instalado"
}

# Fun√ß√£o para instalar Puppeteer dependencies
install_puppeteer_deps() {
    echo -e "${PURPLE} üíª Instalando puppeteer dependencies (Ubuntu 22/24 compatible)...${NC}"
    apt-get install -y \
        ca-certificates \
        fonts-liberation \
        libasound2 \
        libatk-bridge2.0-0 \
        libatk1.0-0 \
        libc6 \
        libcairo2 \
        libcups2 \
        libdbus-1-3 \
        libexpat1 \
        libfontconfig1 \
        libgbm1 \
        libgcc1 \
        libglib2.0-0 \
        libgtk-3-0 \
        libnspr4 \
        libnss3 \
        libpango-1.0-0 \
        libpangocairo-1.0-0 \
        libstdc++6 \
        libx11-6 \
        libx11-xcb1 \
        libxcb1 \
        libxcomposite1 \
        libxcursor1 \
        libxdamage1 \
        libxext6 \
        libxfixes3 \
        libxi6 \
        libxrandr2 \
        libxrender1 \
        libxss1 \
        libxtst6 \
        lsb-release \
        wget \
        xdg-utils

    echo -e "   ‚úÖ Depend√™ncias Puppeteer instaladas"
}

# Fun√ß√£o para instalar depend√™ncias adicionais
install_additional_tools() {
    echo -e "${PURPLE} üíª Instalando ferramentas adicionais...${NC}"

    # Instalar snapd
    apt install -y snapd

    # Instalar nginx
    apt install -y nginx

    # Instalar certbot
    snap install --classic certbot || apt install -y certbot python3-certbot-nginx

    echo -e "   ‚úÖ Ferramentas adicionais instaladas"
}

# Fun√ß√£o para criar usu√°rio deploy
create_deploy_user() {
    echo -e "${PURPLE} üë§ Criando usu√°rio para a instancia...${NC}"

    if ! id "deploy" &>/dev/null; then
        useradd -m -s /bin/bash deploy
        usermod -aG sudo,deploy,docker deploy
        echo -e "   ‚úÖ Usu√°rio 'deploy' criado com sucesso"
    else
        echo -e "   ‚ö†Ô∏è  Usu√°rio 'deploy' j√° existe"
    fi
}

# Fun√ß√£o para baixar e preparar c√≥digo
download_code() {
    echo -e "${PURPLE} üì• Fazendo download do c√≥digo My-Tycket...${NC}"

    # Entrar no diret√≥rio home do deploy
    cd /home/deploy

    # Fazer backup se existir
    if [ -d "whaticketplus" ]; then
        BACKUP_DIR="whaticketplus_backup_$(date +%Y%m%d_%H%M%S)"
        mv whaticketplus "$BACKUP_DIR"
        echo -e "   üì¶ Backup criado: $BACKUP_DIR"
    fi

    # Clonar reposit√≥rio
    git clone https://github.com/DEV7Kadu/My-Tycket.git whaticketplus

    # Ajustar permiss√µes
    chown -R deploy:deploy /home/deploy/whaticketplus

    echo -e "   ‚úÖ C√≥digo baixado com sucesso"
}

# Fun√ß√£o para configurar vari√°veis de ambiente
setup_environment() {
    echo -e "${PURPLE} üîß Configurando vari√°veis de ambiente (backend)...${NC}"

    cd /home/deploy/whaticketplus/C√≥digo\ Fonte/backend

    # Criar .env se n√£o existir
    if [ ! -f ".env" ]; then
        cp .env.example .env 2>/dev/null || echo "NODE_ENV=production" > .env
        echo -e "   ‚úÖ Arquivo .env criado"
    fi

    # Ajustar permiss√µes
    chown deploy:deploy .env
}

# Fun√ß√£o para configurar banco de dados
setup_database() {
    echo -e "${PURPLE} üóÑÔ∏è Criando Redis & Banco Postgres...${NC}"

    # Iniciar Redis
    docker run -d --name redis -p 6379:6379 redis:latest

    # Configurar PostgreSQL
    sudo -u postgres psql -c "CREATE USER deploy WITH PASSWORD 'deploy';" || true
    sudo -u postgres psql -c "ALTER USER deploy CREATEDB;" || true
    sudo -u postgres psql -c "CREATE DATABASE whaticketplus OWNER deploy;" || true

    echo -e "   ‚úÖ Banco de dados configurado"
}

# Fun√ß√£o para instalar depend√™ncias do backend
install_backend_deps() {
    echo -e "${PURPLE} üì¶ Instalando depend√™ncias do backend...${NC}"

    cd /home/deploy/whaticketplus/C√≥digo\ Fonte/backend

    # Instalar como usu√°rio deploy
    sudo -u deploy npm install --force

    echo -e "   ‚úÖ Depend√™ncias do backend instaladas"
}

# Fun√ß√£o para compilar backend
build_backend() {
    echo -e "${PURPLE} üî® Compilando o c√≥digo do backend...${NC}"

    cd /home/deploy/whaticketplus/C√≥digo\ Fonte/backend

    # Compilar como usu√°rio deploy
    sudo -u deploy npm run build

    echo -e "   ‚úÖ Backend compilado"
}

# Fun√ß√£o para rodar migra√ß√µes
run_migrations() {
    echo -e "${PURPLE} üóÑÔ∏è Executando db:migrate...${NC}"

    cd /home/deploy/whaticketplus/C√≥digo\ Fonte/backend

    # Rodar migra√ß√µes como usu√°rio deploy
    sudo -u deploy npm run db:migrate || echo -e "   ‚ö†Ô∏è  Migra√ß√µes podem j√° ter sido executadas"
}

# Fun√ß√£o para rodar seeds
run_seeds() {
    echo -e "${PURPLE} üå± Executando db:seed...${NC}"

    cd /home/deploy/whaticketplus/C√≥digo\ Fonte/backend

    # Rodar seeds como usu√°rio deploy
    sudo -u deploy npm run db:seed || echo -e "   ‚ö†Ô∏è  Seeds podem j√° ter sido executados"
}

# Fun√ß√£o para iniciar backend com PM2
start_backend() {
    echo -e "${PURPLE} üöÄ Iniciando pm2 (backend)...${NC}"

    cd /home/deploy/whaticketplus/C√≥digo\ Fonte/backend

    # Iniciar como usu√°rio deploy
    sudo -u deploy pm2 start dist/server.js --name "whaticketplus-backend"

    echo -e "   ‚úÖ Backend iniciado"
}

# Fun√ß√£o para configurar frontend
setup_frontend() {
    echo -e "${PURPLE} üé® Configurando vari√°veis de ambiente (frontend)...${NC}"

    cd /home/deploy/whaticketplus/C√≥digo\ Fonte/frontend

    # Criar .env se n√£o existir
    if [ ! -f ".env" ]; then
        echo "REACT_APP_BACKEND_URL=https://wapi.whaticketplus.com" > .env
        echo -e "   ‚úÖ Arquivo .env do frontend criado"
    fi
}

# Fun√ß√£o para instalar depend√™ncias do frontend
install_frontend_deps() {
    echo -e "${PURPLE} üì¶ Instalando depend√™ncias do frontend...${NC}"

    cd /home/deploy/whaticketplus/C√≥digo\ Fonte/frontend

    # Instalar como usu√°rio deploy
    sudo -u deploy npm install --force

    echo -e "   ‚úÖ Depend√™ncias do frontend instaladas"
}

# Fun√ß√£o para compilar frontend
build_frontend() {
    echo -e "${PURPLE} üî® Compilando o c√≥digo do frontend...${NC}"

    cd /home/deploy/whaticketplus/C√≥digo\ Fonte/frontend

    # Limpar cache
    sudo -u deploy npm cache clean --force

    # Configurar vari√°veis de build
    export NODE_ENV=production
    export GENERATE_SOURCEMAP=false
    export NODE_OPTIONS="--max-old-space-size=4096"

    echo -e "üßπ Preparando ambiente para build..."
    echo -e "üóëÔ∏è Limpando cache do NPM..."

    # Compilar como usu√°rio deploy
    if sudo -u deploy npm run build; then
        echo -e "   ‚úÖ Frontend compilado com sucesso"
    else
        echo -e "   ‚ö†Ô∏è  Build falhou, criando index.html de emerg√™ncia..."
        # Criar build de emerg√™ncia
        sudo -u deploy mkdir -p build
        cat > build/index.html << 'EOF'
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My-Tycket v28 - Inicializando</title>
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; max-width: 500px; }
        .logo { font-size: 48px; margin-bottom: 20px; }
        h1 { color: #333; margin-bottom: 20px; }
        .status { color: #666; font-size: 18px; margin: 20px 0; }
        .loading { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üöÄ</div>
        <h1>My-Tycket v28.0.0</h1>
        <div class="loading"></div>
        <div class="status">Sistema inicializando...<br><small>Por favor, aguarde enquanto configuramos tudo.</small></div>
        <div style="color: #888; font-size: 14px; margin-top: 30px;">
            <strong>Recursos:</strong><br>
            ‚Ä¢ Dual Provider WhatsApp<br>
            ‚Ä¢ FlowBuilder Visual<br>
            ‚Ä¢ Omnichannel<br>
            ‚Ä¢ API REST Completa
        </div>
    </div>
</body>
</html>
EOF
        echo -e "   ‚úÖ Build de emerg√™ncia criado"
    fi
}

# Fun√ß√£o para criar servidor simples do frontend
create_frontend_server() {
    echo -e "${PURPLE} üåê Criando servidor frontend...${NC}"

    cd /home/deploy/whaticketplus/C√≥digo\ Fonte/frontend

    # Criar servidor simples
    sudo -u deploy tee server.js > /dev/null << 'EOF'
const http = require('http');
const fs = require('fs');
const path = require('path');

const server = http.createServer((req, res) => {
    let filePath = path.join(__dirname, 'build', req.url === '/' ? 'index.html' : req.url);

    if (!fs.existsSync(filePath)) {
        filePath = path.join(__dirname, 'build', 'index.html');
    }

    const extname = path.extname(filePath);
    let contentType = 'text/html';

    switch (extname) {
        case '.js': contentType = 'text/javascript'; break;
        case '.css': contentType = 'text/css'; break;
        case '.json': contentType = 'application/json'; break;
    }

    fs.readFile(filePath, (err, content) => {
        if (err) {
            if (err.code === 'ENOENT') {
                res.writeHead(404);
                res.end('File not found');
            } else {
                res.writeHead(500);
                res.end('Server error');
            }
        } else {
            res.writeHead(200, { 'Content-Type': contentType });
            res.end(content);
        }
    });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, '0.0.0.0', () => {
    console.log(`Frontend server running on port ${PORT}`);
});
EOF

    echo -e "   ‚úÖ Servidor frontend criado"
}

# Fun√ß√£o para iniciar frontend com PM2
start_frontend() {
    echo -e "${PURPLE} üöÄ Iniciando pm2 (frontend)...${NC}"

    cd /home/deploy/whaticketplus/C√≥digo\ Fonte/frontend

    # Iniciar como usu√°rio deploy
    sudo -u deploy pm2 start server.js --name "whaticketplus-frontend"

    echo -e "   ‚úÖ Frontend iniciado"
}

# Fun√ß√£o para configurar PM2 para inicializa√ß√£o autom√°tica
setup_pm2_startup() {
    echo -e "${PURPLE} üîß Configurando PM2 para inicializa√ß√£o autom√°tica...${NC}"

    # Configurar PM2 para iniciar com o sistema (como root)
    pm2 startup

    # Configurar PM2 para o usu√°rio deploy
    sudo -u deploy pm2 startup

    # Salvar processo atual
    pm2 save
    sudo -u deploy pm2 save

    echo -e "   ‚úÖ PM2 configurado para inicializa√ß√£o autom√°tica"
}

# Fun√ß√£o para configurar Nginx
setup_nginx() {
    echo -e "${PURPLE} üåê Configurando nginx (backend)...${NC}"

    # Criar configura√ß√£o do backend
    cat > /etc/nginx/sites-available/whaticketplus-backend << 'EOF'
server {
    listen 80;
    server_name wapi.whaticketplus.com;

    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 24h;
    }
}
EOF

    # Criar configura√ß√£o do frontend
    cat > /etc/nginx/sites-available/whaticketplus-frontend << 'EOF'
server {
    listen 80;
    server_name painel.whaticketplus.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

    # Habilitar sites
    ln -sf /etc/nginx/sites-available/whaticketplus-backend /etc/nginx/sites-enabled/
    ln -sf /etc/nginx/sites-available/whaticketplus-frontend /etc/nginx/sites-enabled/

    # Remover default
    rm -f /etc/nginx/sites-enabled/default

    echo -e "   ‚úÖ Nginx configurado"
}

# Fun√ß√£o para configurar SSL
setup_ssl() {
    echo -e "${PURPLE} üîí Configurando certbot...${NC}"

    # Obter certificado SSL
    certbot --nginx -d wapi.whaticketplus.com -d painel.whaticketplus.com --non-interactive --agree-tos --email admin@whaticketplus.com || echo -e "   ‚ö†Ô∏è  SSL configura√ß√£o manual necess√°ria"

    echo -e "   ‚úÖ Certbot configurado"
}

# Fun√ß√£o para reiniciar servi√ßos
restart_services() {
    echo -e "${PURPLE} üîÑ Reiniciando nginx...${NC}"

    nginx -t
    systemctl restart nginx

    echo -e "   ‚úÖ Nginx reiniciado"
}

# Fun√ß√£o para exibir informa√ß√µes finais
show_final_info() {
    echo ""
    echo -e "${GREEN} ‚úÖ Instala√ß√£o conclu√≠da com sucesso!${NC}"
    echo ""
    echo -e "${CYAN} üåê URLs de Acesso:${NC}"
    echo -e "   üé® Frontend: ${BLUE}${FRONTEND_URL:-https://painel.whaticketplus.com}${NC}"
    echo -e "   üîó API: ${BLUE}${BACKEND_URL:-https://wapi.whaticketplus.com}${NC}"
    echo ""
    echo -e "${CYAN} üìã Informa√ß√µes √öteis:${NC}"
    echo -e "   üåê Dom√≠nio: ${YELLOW}${BASE_URL:-localhost}${NC}"
    echo -e "   üìß Email SSL: ${YELLOW}${SSL_EMAIL:-admin@localhost}${NC}"
    echo -e "   üë§ Usu√°rio: ${YELLOW}deploy${NC}"
    echo -e "   üìÅ Diret√≥rio: ${YELLOW}/home/deploy/whaticketplus${NC}"
    echo -e "   üîß PM2 Status: ${YELLOW}pm2 status${NC}"
    echo -e "   üìä PM2 Logs: ${YELLOW}pm2 logs${NC}"
    echo ""
    echo -e "${CYAN} üõ†Ô∏è Comandos de Gerenciamento:${NC}"
    echo -e "   Reiniciar tudo: ${YELLOW}pm2 restart all${NC}"
    echo -e "   Ver status: ${YELLOW}pm2 status${NC}"
    echo -e "   Ver logs: ${YELLOW}pm2 logs --lines 50${NC}"
    echo ""
    echo -e "${GREEN} üéâ My-Tycket v28 est√° pronto para uso!${NC}"
}

# Fun√ß√£o principal
# Fun√ß√£o para coletar configura√ß√µes do usu√°rio
collect_config() {
    echo -e "${CYAN} ‚öôÔ∏è  Configura√ß√µes do Sistema${NC}"
    echo "=============================================="

    # URL Base
    echo -e "${YELLOW}üåê Informe a URL base para o sistema:${NC}"
    echo -e "${BLUE}Exemplo: seu-dominio.com${NC}"
    read -p "URL Base: " BASE_URL

    if [[ -z "$BASE_URL" ]]; then
        BASE_URL="localhost"
        echo -e "${YELLOW}‚ö†Ô∏è  Usando padr√£o: localhost${NC}"
    fi

    # Email para SSL
    echo ""
    echo -e "${YELLOW}üìß Email para certificado SSL (Let's Encrypt):${NC}"
    read -p "Email: " SSL_EMAIL

    if [[ -z "$SSL_EMAIL" ]]; then
        SSL_EMAIL="admin@${BASE_URL}"
        echo -e "${YELLOW}‚ö†Ô∏è  Usando padr√£o: admin@${BASE_URL}${NC}"
    fi

    # Confirmar configura√ß√µes
    echo ""
    echo -e "${GREEN} üìã Resumo das configura√ß√µes:${NC}"
    echo -e "   üåê URL Base: ${CYAN}${BASE_URL}${NC}"
    echo -e "   üìß Email SSL: ${CYAN}${SSL_EMAIL}${NC}"
    echo ""
    read -p "Confirmar configura√ß√µes? (s/n): " CONFIRM

    if [[ "$CONFIRM" != "s" && "$CONFIRM" != "S" ]]; then
        echo -e "${YELLOW}üîÑ Reiniciando configura√ß√£o...${NC}"
        collect_config
        return
    fi

    # Exportar vari√°veis
    export BASE_URL
    export SSL_EMAIL
    export FRONTEND_URL="https://${BASE_URL}"
    export BACKEND_URL="https://api.${BASE_URL}"
}

main() {
    print_banner
    check_root
    detect_system

    # Coletar configura√ß√µes do usu√°rio
    collect_config

    echo -e "${BLUE} üöÄ Iniciando instala√ß√£o completa...${NC}"
    echo "=============================================="

    # Array para rastrear falhas
    FAILED_STEPS=()

    # Instala√ß√£o de depend√™ncias do sistema com tratamento de erro
    echo -e "${YELLOW} üì¶ Etapa 1/8: Instalando depend√™ncias b√°sicas${NC}"
    if ! install_dependencies; then
        FAILED_STEPS+=("depend√™ncias b√°sicas")
    fi

    echo -e "${YELLOW} üíª Etapa 2/8: Instalando Node.js${NC}"
    if ! install_nodejs; then
        FAILED_STEPS+=("Node.js")
        echo -e "${RED}   ‚ö†Ô∏è  Continuando sem Node.js (pode falhar mais tarde)${NC}"
    fi

    echo -e "${YELLOW} üîß Etapa 3/8: Instalando PM2${NC}"
    if ! install_pm2; then
        FAILED_STEPS+=("PM2")
    fi

    echo -e "${YELLOW} üê≥ Etapa 4/8: Instalando Docker${NC}"
    if ! install_docker; then
        FAILED_STEPS+=("Docker")
        echo -e "${RED}   ‚ö†Ô∏è  Continuando sem Docker (Redis pode falhar)${NC}"
    fi

    echo -e "${YELLOW} üóÑÔ∏è Etapa 5/8: Instalando PostgreSQL${NC}"
    if ! install_postgresql; then
        FAILED_STEPS+=("PostgreSQL")
        echo -e "${RED}   ‚ö†Ô∏è  Continuando sem PostgreSQL (banco de dados pode falhar)${NC}"
    fi

    echo -e "${YELLOW} üé≠ Etapa 6/8: Instalando depend√™ncias Puppeteer${NC}"
    if ! install_puppeteer_deps; then
        FAILED_STEPS+=("depend√™ncias Puppeteer")
        echo -e "${RED}   ‚ö†Ô∏è  Alguns recursos podem n√£o funcionar${NC}"
    fi

    echo -e "${YELLOW} üõ†Ô∏è Etapa 7/8: Instalando ferramentas adicionais${NC}"
    if ! install_additional_tools; then
        FAILED_STEPS+=("ferramentas adicionais")
    fi

    # Configura√ß√£o do sistema
    echo -e "${YELLOW} üë• Etapa 8/8: Configurando sistema${NC}"
    if ! create_deploy_user; then
        FAILED_STEPS+=("cria√ß√£o de usu√°rio")
    fi

    if ! download_code; then
        FAILED_STEPS+=("download do c√≥digo")
    fi

    # Backend
    echo -e "${CYAN} üñ•Ô∏è  Configurando Backend...${NC}"
    if setup_environment; then
        install_backend_deps
        build_backend
        run_migrations
        run_seeds
        start_backend
    else
        FAILED_STEPS+=("configura√ß√£o backend")
    fi

    # Frontend
    echo -e "${CYAN} üé® Configurando Frontend...${NC}"
    if setup_frontend; then
        install_frontend_deps
        build_frontend
        create_frontend_server
        start_frontend
    else
        FAILED_STEPS+=("configura√ß√£o frontend")
    fi

    # Configura√ß√µes finais
    echo -e "${CYAN} üîß Configura√ß√µes Finais...${NC}"
    setup_pm2_startup
    setup_nginx
    setup_ssl
    restart_services

    # Informa√ß√µes finais com status
    if [ ${#FAILED_STEPS[@]} -eq 0 ]; then
        echo ""
        echo -e "${GREEN} üéâ INSTALA√á√ÉO CONCLU√çDA COM SUCESSO TOTAL!${NC}"
    else
        echo ""
        echo -e "${YELLOW} ‚ö†Ô∏è  INSTALA√á√ÉO CONCLU√çDA COM ALERTAS:${NC}"
        for step in "${FAILED_STEPS[@]}"; do
            echo -e "   ‚Ä¢ $step"
        done
        echo ""
        echo -e "${YELLOW} üí° Alguns recursos podem n√£o funcionar perfeitamente${NC}"
    fi

    show_final_info

    # Status dos servi√ßos
    echo ""
    echo -e "${CYAN} üìä Status dos Servi√ßos:${NC}"
    echo "=============================================="

    # Verificar PM2
    if command -v pm2 >/dev/null 2>&1; then
        echo -e "   üöÄ PM2: $(pm2 list | grep -c "online") processos online"
        pm2 list --format json | jq -r '.[] | "\(.name): \(.status)"' 2>/dev/null | while read line; do
            echo -e "      ‚Ä¢ $line"
        done
    else
        echo -e "   ‚ùå PM2: N√£o instalado"
    fi

    # Verificar Docker
    if command -v docker >/dev/null 2>&1; then
        echo -e "   üê≥ Docker: $(docker --version | cut -d' ' -f3 | cut -d'-' -f1)"
    else
        echo -e "   ‚ùå Docker: N√£o instalado"
    fi

    # Verificar PostgreSQL
    if command -v psql >/dev/null 2>&1; then
        echo -e "   üóÑÔ∏è PostgreSQL: $(psql --version | cut -d' ' -f3)"
    else
        echo -e "   ‚ùå PostgreSQL: N√£o instalado"
    fi

    # Verificar Nginx
    if systemctl is-active --quiet nginx; then
        echo -e "   üåê Nginx: Ativo"
    else
        echo -e "   ‚ùå Nginx: Inativo"
    fi
}

# Executar fun√ß√£o principal
main "$@"