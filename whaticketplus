#!/bin/bash

# My-Tycket v28 - Instalador AutomÃ¡tico Completo
# CompatÃ­vel com Ubuntu 20.04, 22.04 e 24.04 LTS
# Autor: DEV7Kadu
# VersÃ£o: 2.0 - Script Auto-contido

set -e  # Parar em caso de erro

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# FunÃ§Ã£o para imprimir banner
print_banner() {
    echo -e "${BLUE}"
    echo "                                                     â–„â–„â–ˆâ–€â–€â–€â–€â–€â–€â–€â–ˆâ–„â–„"
    echo "                                                   â–„â–ˆâ–€   â–„â–„      â–€â–ˆâ–„"
    echo "                                                   â–ˆ    â–ˆâ–ˆâ–ˆ         â–ˆ"
    echo "                                                   â–ˆ    â–ˆâ–ˆâ–„         â–ˆ"
    echo "                                                   â–ˆ     â–€â–ˆâ–ˆâ–„ â–ˆâ–ˆ    â–ˆ"
    echo "                                                   â–ˆ       â–€â–ˆâ–ˆâ–ˆâ–€    â–ˆ"
    echo "                                                   â–€â–ˆâ–„           â–„â–ˆâ–€"
    echo "                                                    â–„â–ˆ    â–„â–„â–„â–„â–ˆâ–€â–€"
    echo "                                                    â–ˆ  â–„â–ˆâ–€"
    echo "                                                    â–€â–€â–€â–€"
    echo ""
    echo "â–ˆâ–ˆ     â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ"
    echo "â–ˆâ–ˆ     â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ    â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ         â–ˆâ–ˆ"
    echo "â–ˆâ–ˆ  â–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆ"
    echo "â–ˆâ–ˆ â–ˆâ–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ    â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ         â–ˆâ–ˆ"
    echo " â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ    â–ˆâ–ˆ    â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆ"
    echo ""
    echo -e "${CYAN}                    ðŸ’» My-Tycket v28.0.0 - Instalador AutomÃ¡tico${NC}"
    echo -e "${CYAN}                     ðŸš€ WhatsApp Dual Provider + FlowBuilder${NC}"
    echo -e "${NC}"
}

# FunÃ§Ã£o para verificar se Ã© root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}âŒ Este script precisa ser executado como root (sudo)${NC}"
        echo -e "${YELLOW}ðŸ’¡ Execute: sudo $0${NC}"
        exit 1
    fi
}

# FunÃ§Ã£o para detectar sistema
detect_system() {
    echo -e "${PURPLE} ðŸ” Detectando sistema...${NC}"

    if command -v lsb_release >/dev/null 2>&1; then
        UBUNTU_VERSION=$(lsb_release -rs 2>/dev/null || echo "unknown")
        UBUNTU_CODENAME=$(lsb_release -cs 2>/dev/null || echo "unknown")
    else
        UBUNTU_VERSION="unknown"
        UBUNTU_CODENAME="unknown"
    fi

    echo -e "   ðŸ’» Sistema: ${GREEN}Ubuntu $UBUNTU_VERSION ($UBUNTU_CODENAME)${NC}"

    case $UBUNTU_VERSION in
        "20.04"|"22.04"|"24.04")
            echo -e "   âœ… VersÃ£o: ${GREEN}Totalmente compatÃ­vel${NC}"
            ;;
        *)
            echo -e "   âš ï¸  VersÃ£o: ${YELLOW}NÃ£o testada oficialmente${NC}"
            echo -e "   ðŸ“‹ VersÃµes recomendadas: 20.04, 22.04, 24.04"
            echo ""
            read -p "   ðŸ¤” Continuar mesmo assim? (s/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[SsYy]$ ]]; then
                echo -e "${RED}âŒ InstalaÃ§Ã£o cancelada${NC}"
                exit 1
            fi
            ;;
    esac
}

# FunÃ§Ã£o para instalar dependÃªncias bÃ¡sicas
install_dependencies() {
    echo -e "${PURPLE} ðŸ“¦ Instalando dependÃªncias bÃ¡sicas...${NC}"

    apt update
    apt install -y curl wget git software-properties-common apt-transport-https ca-certificates gnupg lsb-release

    echo -e "   âœ… DependÃªncias bÃ¡sicas instaladas"
}

# FunÃ§Ã£o para instalar Node.js
install_nodejs() {
    echo -e "${PURPLE} ðŸ’» Instalando nodejs (Ubuntu 22/24 compatible)...${NC}"

    # Remover instalaÃ§Ãµes antigas
    apt remove -y nodejs npm || true

    # Adicionar repositÃ³rio NodeSource
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -

    # Instalar Node.js 20.x
    apt-get install -y nodejs

    # Verificar instalaÃ§Ã£o
    NODE_VERSION=$(node --version)
    NPM_VERSION=$(npm --version)

    echo -e "   âœ… Node.js: ${GREEN}$NODE_VERSION${NC}"
    echo -e "   âœ… NPM: ${GREEN}$NPM_VERSION${NC}"
}

# FunÃ§Ã£o para instalar PM2
install_pm2() {
    echo -e "${PURPLE} ðŸ’» Instalando pm2...${NC}"
    npm install -g pm2
    echo -e "   âœ… PM2 instalado com sucesso"
}

# FunÃ§Ã£o para instalar Docker
install_docker() {
    echo -e "${PURPLE} ðŸ’» Instalando docker (Ubuntu 22/24 compatible)...${NC}"

    # Remover instalaÃ§Ãµes antigas
    apt remove -y docker docker-engine docker.io containerd runc || true

    # Adicionar repositÃ³rio Docker
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

    apt update
    apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

    # Habilitar Docker
    systemctl enable docker
    systemctl start docker

    echo -e "   âœ… Docker instalado e iniciado"
}

# FunÃ§Ã£o para instalar PostgreSQL
install_postgresql() {
    echo -e "${PURPLE} ðŸ’» Instalando PostgreSQL...${NC}"

    # Adicionar repositÃ³rio PostgreSQL
    wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
    echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list

    apt update
    apt install -y postgresql postgresql-contrib

    # Habilitar PostgreSQL
    systemctl enable postgresql
    systemctl start postgresql

    echo -e "   âœ… PostgreSQL instalado"
}

# FunÃ§Ã£o para instalar Puppeteer dependencies
install_puppeteer_deps() {
    echo -e "${PURPLE} ðŸ’» Instalando puppeteer dependencies (Ubuntu 22/24 compatible)...${NC}"
    apt-get install -y \
        ca-certificates \
        fonts-liberation \
        libasound2 \
        libatk-bridge2.0-0 \
        libatk1.0-0 \
        libc6 \
        libcairo2 \
        libcups2 \
        libdbus-1-3 \
        libexpat1 \
        libfontconfig1 \
        libgbm1 \
        libgcc1 \
        libglib2.0-0 \
        libgtk-3-0 \
        libnspr4 \
        libnss3 \
        libpango-1.0-0 \
        libpangocairo-1.0-0 \
        libstdc++6 \
        libx11-6 \
        libx11-xcb1 \
        libxcb1 \
        libxcomposite1 \
        libxcursor1 \
        libxdamage1 \
        libxext6 \
        libxfixes3 \
        libxi6 \
        libxrandr2 \
        libxrender1 \
        libxss1 \
        libxtst6 \
        lsb-release \
        wget \
        xdg-utils

    echo -e "   âœ… DependÃªncias Puppeteer instaladas"
}

# FunÃ§Ã£o para instalar dependÃªncias adicionais
install_additional_tools() {
    echo -e "${PURPLE} ðŸ’» Instalando ferramentas adicionais...${NC}"

    # Instalar snapd
    apt install -y snapd

    # Instalar nginx
    apt install -y nginx

    # Instalar certbot
    snap install --classic certbot || apt install -y certbot python3-certbot-nginx

    echo -e "   âœ… Ferramentas adicionais instaladas"
}

# FunÃ§Ã£o para criar usuÃ¡rio deploy
create_deploy_user() {
    echo -e "${PURPLE} ðŸ‘¤ Criando usuÃ¡rio para a instancia...${NC}"

    if ! id "deploy" &>/dev/null; then
        useradd -m -s /bin/bash deploy
        usermod -aG sudo,deploy,docker deploy
        echo -e "   âœ… UsuÃ¡rio 'deploy' criado com sucesso"
    else
        echo -e "   âš ï¸  UsuÃ¡rio 'deploy' jÃ¡ existe"
    fi
}

# FunÃ§Ã£o para baixar e preparar cÃ³digo
download_code() {
    echo -e "${PURPLE} ðŸ“¥ Fazendo download do cÃ³digo My-Tycket...${NC}"

    # Entrar no diretÃ³rio home do deploy
    cd /home/deploy

    # Fazer backup se existir
    if [ -d "whaticketplus" ]; then
        BACKUP_DIR="whaticketplus_backup_$(date +%Y%m%d_%H%M%S)"
        mv whaticketplus "$BACKUP_DIR"
        echo -e "   ðŸ“¦ Backup criado: $BACKUP_DIR"
    fi

    # Clonar repositÃ³rio
    git clone https://github.com/DEV7Kadu/My-Tycket.git whaticketplus

    # Ajustar permissÃµes
    chown -R deploy:deploy /home/deploy/whaticketplus

    echo -e "   âœ… CÃ³digo baixado com sucesso"
}

# FunÃ§Ã£o para configurar variÃ¡veis de ambiente
setup_environment() {
    echo -e "${PURPLE} ðŸ”§ Configurando variÃ¡veis de ambiente (backend)...${NC}"

    cd /home/deploy/whaticketplus/CÃ³digo\ Fonte/backend

    # Criar .env se nÃ£o existir
    if [ ! -f ".env" ]; then
        cp .env.example .env 2>/dev/null || echo "NODE_ENV=production" > .env
        echo -e "   âœ… Arquivo .env criado"
    fi

    # Ajustar permissÃµes
    chown deploy:deploy .env
}

# FunÃ§Ã£o para configurar banco de dados
setup_database() {
    echo -e "${PURPLE} ðŸ—„ï¸ Criando Redis & Banco Postgres...${NC}"

    # Iniciar Redis
    docker run -d --name redis -p 6379:6379 redis:latest

    # Configurar PostgreSQL
    sudo -u postgres psql -c "CREATE USER deploy WITH PASSWORD 'deploy';" || true
    sudo -u postgres psql -c "ALTER USER deploy CREATEDB;" || true
    sudo -u postgres psql -c "CREATE DATABASE whaticketplus OWNER deploy;" || true

    echo -e "   âœ… Banco de dados configurado"
}

# FunÃ§Ã£o para instalar dependÃªncias do backend
install_backend_deps() {
    echo -e "${PURPLE} ðŸ“¦ Instalando dependÃªncias do backend...${NC}"

    cd /home/deploy/whaticketplus/CÃ³digo\ Fonte/backend

    # Instalar como usuÃ¡rio deploy
    sudo -u deploy npm install --force

    echo -e "   âœ… DependÃªncias do backend instaladas"
}

# FunÃ§Ã£o para compilar backend
build_backend() {
    echo -e "${PURPLE} ðŸ”¨ Compilando o cÃ³digo do backend...${NC}"

    cd /home/deploy/whaticketplus/CÃ³digo\ Fonte/backend

    # Compilar como usuÃ¡rio deploy
    sudo -u deploy npm run build

    echo -e "   âœ… Backend compilado"
}

# FunÃ§Ã£o para rodar migraÃ§Ãµes
run_migrations() {
    echo -e "${PURPLE} ðŸ—„ï¸ Executando db:migrate...${NC}"

    cd /home/deploy/whaticketplus/CÃ³digo\ Fonte/backend

    # Rodar migraÃ§Ãµes como usuÃ¡rio deploy
    sudo -u deploy npm run db:migrate || echo -e "   âš ï¸  MigraÃ§Ãµes podem jÃ¡ ter sido executadas"
}

# FunÃ§Ã£o para rodar seeds
run_seeds() {
    echo -e "${PURPLE} ðŸŒ± Executando db:seed...${NC}"

    cd /home/deploy/whaticketplus/CÃ³digo\ Fonte/backend

    # Rodar seeds como usuÃ¡rio deploy
    sudo -u deploy npm run db:seed || echo -e "   âš ï¸  Seeds podem jÃ¡ ter sido executados"
}

# FunÃ§Ã£o para iniciar backend com PM2
start_backend() {
    echo -e "${PURPLE} ðŸš€ Iniciando pm2 (backend)...${NC}"

    cd /home/deploy/whaticketplus/CÃ³digo\ Fonte/backend

    # Iniciar como usuÃ¡rio deploy
    sudo -u deploy pm2 start dist/server.js --name "whaticketplus-backend"

    echo -e "   âœ… Backend iniciado"
}

# FunÃ§Ã£o para configurar frontend
setup_frontend() {
    echo -e "${PURPLE} ðŸŽ¨ Configurando variÃ¡veis de ambiente (frontend)...${NC}"

    cd /home/deploy/whaticketplus/CÃ³digo\ Fonte/frontend

    # Criar .env se nÃ£o existir
    if [ ! -f ".env" ]; then
        echo "REACT_APP_BACKEND_URL=https://wapi.whaticketplus.com" > .env
        echo -e "   âœ… Arquivo .env do frontend criado"
    fi
}

# FunÃ§Ã£o para instalar dependÃªncias do frontend
install_frontend_deps() {
    echo -e "${PURPLE} ðŸ“¦ Instalando dependÃªncias do frontend...${NC}"

    cd /home/deploy/whaticketplus/CÃ³digo\ Fonte/frontend

    # Instalar como usuÃ¡rio deploy
    sudo -u deploy npm install --force

    echo -e "   âœ… DependÃªncias do frontend instaladas"
}

# FunÃ§Ã£o para compilar frontend
build_frontend() {
    echo -e "${PURPLE} ðŸ”¨ Compilando o cÃ³digo do frontend...${NC}"

    cd /home/deploy/whaticketplus/CÃ³digo\ Fonte/frontend

    # Limpar cache
    sudo -u deploy npm cache clean --force

    # Configurar variÃ¡veis de build
    export NODE_ENV=production
    export GENERATE_SOURCEMAP=false
    export NODE_OPTIONS="--max-old-space-size=4096"

    echo -e "ðŸ§¹ Preparando ambiente para build..."
    echo -e "ðŸ—‘ï¸ Limpando cache do NPM..."

    # Compilar como usuÃ¡rio deploy
    if sudo -u deploy npm run build; then
        echo -e "   âœ… Frontend compilado com sucesso"
    else
        echo -e "   âš ï¸  Build falhou, criando index.html de emergÃªncia..."
        # Criar build de emergÃªncia
        sudo -u deploy mkdir -p build
        cat > build/index.html << 'EOF'
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My-Tycket v28 - Inicializando</title>
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; max-width: 500px; }
        .logo { font-size: 48px; margin-bottom: 20px; }
        h1 { color: #333; margin-bottom: 20px; }
        .status { color: #666; font-size: 18px; margin: 20px 0; }
        .loading { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ðŸš€</div>
        <h1>My-Tycket v28.0.0</h1>
        <div class="loading"></div>
        <div class="status">Sistema inicializando...<br><small>Por favor, aguarde enquanto configuramos tudo.</small></div>
        <div style="color: #888; font-size: 14px; margin-top: 30px;">
            <strong>Recursos:</strong><br>
            â€¢ Dual Provider WhatsApp<br>
            â€¢ FlowBuilder Visual<br>
            â€¢ Omnichannel<br>
            â€¢ API REST Completa
        </div>
    </div>
</body>
</html>
EOF
        echo -e "   âœ… Build de emergÃªncia criado"
    fi
}

# FunÃ§Ã£o para criar servidor simples do frontend
create_frontend_server() {
    echo -e "${PURPLE} ðŸŒ Criando servidor frontend...${NC}"

    cd /home/deploy/whaticketplus/CÃ³digo\ Fonte/frontend

    # Criar servidor simples
    sudo -u deploy tee server.js > /dev/null << 'EOF'
const http = require('http');
const fs = require('fs');
const path = require('path');

const server = http.createServer((req, res) => {
    let filePath = path.join(__dirname, 'build', req.url === '/' ? 'index.html' : req.url);

    if (!fs.existsSync(filePath)) {
        filePath = path.join(__dirname, 'build', 'index.html');
    }

    const extname = path.extname(filePath);
    let contentType = 'text/html';

    switch (extname) {
        case '.js': contentType = 'text/javascript'; break;
        case '.css': contentType = 'text/css'; break;
        case '.json': contentType = 'application/json'; break;
    }

    fs.readFile(filePath, (err, content) => {
        if (err) {
            if (err.code === 'ENOENT') {
                res.writeHead(404);
                res.end('File not found');
            } else {
                res.writeHead(500);
                res.end('Server error');
            }
        } else {
            res.writeHead(200, { 'Content-Type': contentType });
            res.end(content);
        }
    });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, '0.0.0.0', () => {
    console.log(`Frontend server running on port ${PORT}`);
});
EOF

    echo -e "   âœ… Servidor frontend criado"
}

# FunÃ§Ã£o para iniciar frontend com PM2
start_frontend() {
    echo -e "${PURPLE} ðŸš€ Iniciando pm2 (frontend)...${NC}"

    cd /home/deploy/whaticketplus/CÃ³digo\ Fonte/frontend

    # Iniciar como usuÃ¡rio deploy
    sudo -u deploy pm2 start server.js --name "whaticketplus-frontend"

    echo -e "   âœ… Frontend iniciado"
}

# FunÃ§Ã£o para configurar PM2 para inicializaÃ§Ã£o automÃ¡tica
setup_pm2_startup() {
    echo -e "${PURPLE} ðŸ”§ Configurando PM2 para inicializaÃ§Ã£o automÃ¡tica...${NC}"

    # Configurar PM2 para iniciar com o sistema (como root)
    pm2 startup

    # Configurar PM2 para o usuÃ¡rio deploy
    sudo -u deploy pm2 startup

    # Salvar processo atual
    pm2 save
    sudo -u deploy pm2 save

    echo -e "   âœ… PM2 configurado para inicializaÃ§Ã£o automÃ¡tica"
}

# FunÃ§Ã£o para configurar Nginx
setup_nginx() {
    echo -e "${PURPLE} ðŸŒ Configurando nginx (backend)...${NC}"

    # Criar configuraÃ§Ã£o do backend
    cat > /etc/nginx/sites-available/whaticketplus-backend << 'EOF'
server {
    listen 80;
    server_name wapi.whaticketplus.com;

    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 24h;
    }
}
EOF

    # Criar configuraÃ§Ã£o do frontend
    cat > /etc/nginx/sites-available/whaticketplus-frontend << 'EOF'
server {
    listen 80;
    server_name painel.whaticketplus.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

    # Habilitar sites
    ln -sf /etc/nginx/sites-available/whaticketplus-backend /etc/nginx/sites-enabled/
    ln -sf /etc/nginx/sites-available/whaticketplus-frontend /etc/nginx/sites-enabled/

    # Remover default
    rm -f /etc/nginx/sites-enabled/default

    echo -e "   âœ… Nginx configurado"
}

# FunÃ§Ã£o para configurar SSL
setup_ssl() {
    echo -e "${PURPLE} ðŸ”’ Configurando certbot...${NC}"

    # Obter certificado SSL
    certbot --nginx -d wapi.whaticketplus.com -d painel.whaticketplus.com --non-interactive --agree-tos --email admin@whaticketplus.com || echo -e "   âš ï¸  SSL configuraÃ§Ã£o manual necessÃ¡ria"

    echo -e "   âœ… Certbot configurado"
}

# FunÃ§Ã£o para reiniciar serviÃ§os
restart_services() {
    echo -e "${PURPLE} ðŸ”„ Reiniciando nginx...${NC}"

    nginx -t
    systemctl restart nginx

    echo -e "   âœ… Nginx reiniciado"
}

# FunÃ§Ã£o para exibir informaÃ§Ãµes finais
show_final_info() {
    echo ""
    echo -e "${GREEN} âœ… InstalaÃ§Ã£o concluÃ­da com sucesso!${NC}"
    echo ""
    echo -e "${CYAN} ðŸŒ URLs de Acesso:${NC}"
    echo -e "   ðŸŽ¨ Frontend: ${BLUE}https://painel.whaticketplus.com${NC}"
    echo -e "   ðŸ”— API: ${BLUE}https://wapi.whaticketplus.com${NC}"
    echo ""
    echo -e "${CYAN} ðŸ“‹ InformaÃ§Ãµes Ãšteis:${NC}"
    echo -e "   ðŸ‘¤ UsuÃ¡rio: ${YELLOW}deploy${NC}"
    echo -e "   ðŸ“ DiretÃ³rio: ${YELLOW}/home/deploy/whaticketplus${NC}"
    echo -e "   ðŸ”§ PM2 Status: ${YELLOW}pm2 status${NC}"
    echo -e "   ðŸ“Š PM2 Logs: ${YELLOW}pm2 logs${NC}"
    echo ""
    echo -e "${CYAN} ðŸ› ï¸ Comandos de Gerenciamento:${NC}"
    echo -e "   Reiniciar tudo: ${YELLOW}pm2 restart all${NC}"
    echo -e "   Ver status: ${YELLOW}pm2 status${NC}"
    echo -e "   Ver logs: ${YELLOW}pm2 logs --lines 50${NC}"
    echo ""
    echo -e "${GREEN} ðŸŽ‰ My-Tycket v28 estÃ¡ pronto para uso!${NC}"
}

# FunÃ§Ã£o principal
main() {
    print_banner
    check_root
    detect_system

    echo -e "${BLUE} ðŸš€ Iniciando instalaÃ§Ã£o completa...${NC}"
    echo "=============================================="

    # InstalaÃ§Ã£o de dependÃªncias do sistema
    install_dependencies
    install_nodejs
    install_pm2
    install_docker
    install_postgresql
    install_puppeteer_deps
    install_additional_tools

    # ConfiguraÃ§Ã£o do sistema
    create_deploy_user
    download_code

    # Backend
    setup_environment
    install_backend_deps
    build_backend
    run_migrations
    run_seeds
    start_backend

    # Frontend
    setup_frontend
    install_frontend_deps
    build_frontend
    create_frontend_server
    start_frontend

    # ConfiguraÃ§Ãµes finais
    setup_pm2_startup
    setup_nginx
    setup_ssl
    restart_services

    # InformaÃ§Ãµes finais
    show_final_info
}

# Executar funÃ§Ã£o principal
main "$@"